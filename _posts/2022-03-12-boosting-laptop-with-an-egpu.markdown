---
title: Boosting my laptop with an eGPU
layout: post
subtitle: "GTX3060 + Mantiz Saturn Pro"
tags: ["ubuntu", "egpu", "nvidia", "mantiz saturn pro"]
---

I decided boost the power of my [Thinkpad X1 Carbon Gen 6][x1c]{:target="_blank"}, which is now 3 years old to the date with an eGPU. 

I bought a [ASUS GeForce RTX 3060 12GB TUF Gaming][gtx3060]{:target="_blank"} and a [Mantiz Saturn Pro][mantiz]{:target="_blank"}

The setup took me a couple of days, as I am runnig ubuntu (20.04) as my primary OS. Had a lot of troubles with kernel `5.4.0-104-generic`, modules didn't want to get build and rebooting just hanged into a blank screen. For some reason `5.4.0-100-generic` seems work fine, but to figure that out I lost half a day of bashing my head.

I am also using a secondary [Lenovo ThinkPad Thunderbolt 3 Dock][dock]{:target="_blank"} as this laptop has 2 thunderbolt 3 ports - which is very convenient. The not-so-cool thing being that both thunderbolt ports run on the same bus, so no matter where you connect your devices - the bandwidth will be the shared, however the Thinkpad dock has much more ports to connect stuff to, and the Mantiz has only 2 usb ports on the back and I don't want cables dangling from the front side (3 USBs there).

### The tricky part: switching eGPU<->internal

Disconnecting the dock and going back to embeded intel/i915.

Simplest thing to do is have 2 xorg.conf files, one having the nvidia settings, and the other having the intel settings. A **very** important Option here is the ```"AllowExternalGpus" "True"  ``` without it the external card didn't want to start at all.

nvidia (generated by `sudo nvidia-xconfig --prime`):
```
Section "ServerLayout"
    Identifier     "Layout0"
    Screen      0  "Screen0" 0 0
    Inactive       "InactiveDevice1"
    InputDevice    "Keyboard0" "CoreKeyboard"
    InputDevice    "Mouse0" "CorePointer"
    Option         "AllowExternalGpus" "1"
EndSection

Section "Files"
EndSection

Section "InputDevice"

    # generated from default
    Identifier     "Mouse0"
    Driver         "mouse"
    Option         "Protocol" "auto"
    Option         "Device" "/dev/psaux"
    Option         "Emulate3Buttons" "no"
    Option         "ZAxisMapping" "4 5"
EndSection

Section "InputDevice"

    # generated from default
    Identifier     "Keyboard0"
    Driver         "kbd"
EndSection

Section "Monitor"
    Identifier     "Monitor0"
    VendorName     "Unknown"
    ModelName      "Unknown"
    Option         "DPMS"
EndSection

Section "Device"
    Identifier     "Device0"
    Driver         "nvidia"
    VendorName     "NVIDIA Corporation"
    BusID          "PCI:10:0:0"
EndSection

Section "Device"
    Identifier     "InactiveDevice1"
    Driver         "modesetting"
    VendorName     "Unknown"
EndSection

Section "Screen"
    Identifier     "Screen0"
    Device         "Device0"
    Monitor        "Monitor0"
    DefaultDepth    24
    Option         "AllowEmptyInitialConfiguration" "True"
    Option         "AllowExternalGpus" "True"
    SubSection     "Display"
        Depth       24
    EndSubSection
EndSection
                                                                     
```

intel:
```
Section "Device"                                                                
    Identifier     "iris"                                                       
    #Driver         "modesetting"                                               
    Driver         "i915"                                                       
    BusID          "PCI:0:2:0"                                                  
EndSection                                                                      

```

Then just swapping both files and doing ```sudo service gdm3 restart``` did the job to switch back to the internal graphics card, however trying to switch back to the nvidia proved to be impossible, even disconncting and reconnecting the dock - didn't help. I had to reboot. Still looking for a solution and will update the article when I find it.


[dock]: https://www.lenovo.com/us/en/p/accessories-and-software/docking/docking_thunderbolt-docks-(universal-cable-docks)/40an0135us
[x1c]: https://www.lenovo.com/bg/bg/laptops/thinkpad/thinkpad-x1/ThinkPad-X1-Carbon-6th-Gen/p/22TP2TXX16G
[gtx3060]: https://www.asus.com/Motherboards-Components/Graphics-Cards/TUF-Gaming/TUF-RTX3060-O12G-GAMING/
[mantiz]: https://mymantiz.com/products/mantiz-mz-03-saturn-pro-egpu-v2